name: Weekly Pages Update Digest

on:
  push:
    branches:
      - feature/add-notification
  schedule:
    # 毎週月曜日の朝 9:00 (JST)
    - cron: '0 0 * * 1'
  workflow_dispatch:

jobs:
  digest-notification:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: read
      
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Collect Merged PRs for src/pages
        id: collect-prs
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # 1829番のPRが持っているファイルパスを具体的に表示させる
          echo "--- Files in PR #1829 ---"
          gh pr view 1829 --json files -q '.files[].path'
          
          # 判定ロジックを通るかテスト
          echo "--- Path Match Test ---"
          FILES=$(gh pr view 1829 --json files -q '.files[].path')
          if echo "$FILES" | grep -q "^src/pages/"; then
            echo "Match found!"
          else
            echo "No match. Actual paths start with something else."
          fi
  
      - name: Send Slack Notification
        uses: rtCamp/action-slack-notify@v2
        env:
          SLACK_WEBHOOK: ${{ secrets.SLACK_WEBHOOK_URL_CE }}
          SLACK_CHANNEL: 'notify-update'
          SLACK_USERNAME: 'Weekly Pages Digest'
          SLACK_COLOR: ${{ steps.collect-prs.outputs.count > 0 && '#36a64f' || '#cccccc' }}
          SLACK_TITLE: 'Weekly Update: src/pages/'
          SLACK_MESSAGE: |
            ${{ steps.collect-prs.outputs.count > 0 
                && format('先週、src/pages/ に以下の変更がマージされました:\n\n{0}', env.PR_MESSAGE) 
                || '先週、src/pages/ 配下の変更はありませんでした。' }}
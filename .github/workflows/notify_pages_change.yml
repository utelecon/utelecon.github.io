name: Weekly Pages Update Digest

on:
  push:
    branches:
      - feature/add-notification
  schedule:
    # 毎週月曜日の朝 9:00 (JST)
    - cron: '0 0 * * 1'
  workflow_dispatch:

jobs:
  digest-notification:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: read
      
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Collect Merged PRs for src/pages
        id: collect-prs
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # 基準日の確認
          SINCE_UNIX=$(date -d "7 days ago" +%s)
          echo "Threshold (Unix): $SINCE_UNIX"
          echo "Threshold (Date): $(date -d @$SINCE_UNIX)"

          # 直近のPRのマージ日時を表示
          echo "--- Checking PR Dates ---"
          gh pr list --base main --state merged --limit 5 --json number,mergedAt,title \
            | jq -r '.[] | "PR #\(.number) merged at: \(.mergedAt) \t(Unix: \(.mergedAt | fromdateiso8601))"'          


          # 1. 比較基準となる時刻（7日前）をUNIXタイムで取得
          SINCE_UNIX=$(date -d "30 days ago" +%s)
          echo "Target since (Unix): $SINCE_UNIX"

          # 2. PRリストを取得し、jq内でUNIXタイムに変換して比較
          # fromdateiso8601 を使うことで確実に数値比較を行います
          PR_DATA=$(gh pr list --base main --state merged --json number,title,url,mergedAt,files --limit 100 \
            | jq -r --argjson since "$SINCE_UNIX" '
              .[] | 
              select((.mergedAt | fromdateiso8601) >= $since) | 
              select(.files[].path | startswith("src/pages/")) | 
              {number, title, url}' \
            | jq -s 'unique_by(.number) // []')

          COUNT=$(echo "$PR_DATA" | jq '. | length')
          echo "Found $COUNT matching PRs."

          if [ "$COUNT" -gt 0 ]; then
            PR_LIST=$(echo "$PR_DATA" | jq -r '.[] | "• <\(.url)|#\(.number)>: \(.title)"')
            {
              echo "PR_MESSAGE<<EOF"
              echo "$PR_LIST"
              echo "EOF"
            } >> $GITHUB_ENV
          fi

          echo "count=$COUNT" >> $GITHUB_OUTPUT
  
      - name: Send Slack Notification
        uses: rtCamp/action-slack-notify@v2
        env:
          SLACK_WEBHOOK: ${{ secrets.SLACK_WEBHOOK_URL_CE }}
          SLACK_CHANNEL: 'notify-update'
          SLACK_USERNAME: 'Weekly Pages Digest'
          SLACK_COLOR: ${{ steps.collect-prs.outputs.count > 0 && '#36a64f' || '#cccccc' }}
          SLACK_TITLE: 'Weekly Update: src/pages/'
          SLACK_MESSAGE: |
            ${{ steps.collect-prs.outputs.count > 0 
                && format('先週、src/pages/ に以下の変更がマージされました:\n\n{0}', env.PR_MESSAGE) 
                || '先週、src/pages/ 配下の変更はありませんでした。' }}